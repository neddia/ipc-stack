services:
  influxdb:
    image: influxdb:2.7
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME_FILE: /run/secrets/influx_admin_user
      DOCKER_INFLUXDB_INIT_PASSWORD_FILE: /run/secrets/influx_admin_pass
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG:-edge-org}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET:-edge-site}
      DOCKER_INFLUXDB_INIT_RETENTION: ${INFLUX_RETENTION:-30d}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN_FILE: /run/secrets/influx_admin_token
    volumes:
      - influx-data:/var/lib/influxdb2
      - influx-config:/etc/influxdb2
    secrets:
      - influx_admin_user
      - influx_admin_pass
      - influx_admin_token

  site-agent:
    image: ${SITE_AGENT_IMAGE}:${SITE_AGENT_VERSION}
    restart: unless-stopped
    user: "${SITE_AGENT_UID:-1000}:${SITE_AGENT_GID:-1000}"
    env_file:
      - ${ENV_FILE:-./.env}
    environment:
      INFLUX_URL: ${INFLUX_URL:-http://influxdb:8086}
      INFLUX_ORG: ${INFLUX_ORG:-edge-org}
      INFLUX_BUCKET: ${INFLUX_BUCKET:-edge-site}
      INFLUX_TOKEN_FILE: /run/secrets/influx.admin.token
    depends_on:
      - influxdb
    volumes:
      - ${IPC_STORAGE_DIR:-/opt/site-agent/storage}:/app/storage
      - ${IPC_SECRETS_DIR:-/opt/site-agent/.secrets}:/run/secrets:ro
    ports:
      - "8000:8000"

  gatewayd:
    image: ${GATEWAYD_IMAGE:-ghcr.io/neddia/gatewayd}:${GATEWAYD_VERSION:-latest}
    restart: unless-stopped
    env_file:
      - ${ENV_FILE:-./.env}
    environment:
      SITE_CONFIG_PATH: /data/site-config.yml
      GATEWAYD_DB_PATH: /data/gatewayd.sqlite3
      GATEWAYD_PROFILES_DIR: /data/profiles
    depends_on:
      - influxdb
    volumes:
      - ${IPC_STORAGE_DIR:-/opt/site-agent/storage}:/data
      - ${IPC_SECRETS_DIR:-/opt/site-agent/.secrets}:/run/secrets:ro
    ports:
      - "8080:8080"

  telegraf:
    image: telegraf:1.29
    user: "0:0"
    restart: unless-stopped
    depends_on:
      - influxdb
    environment:
      INFLUX_ORG: ${INFLUX_ORG:-edge-org}
      INFLUX_BUCKET: ${INFLUX_BUCKET:-edge-site}
      TELEGRAF_BUCKET: ${TELEGRAF_BUCKET:-telegraf}
      HOST_PROC: /host/proc
      HOST_SYS: /host/sys
    volumes:
      - ./${TELEGRAF_CONF:-telegraf.conf}:/etc/telegraf/telegraf.conf:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host:ro
      - ${IPC_SECRETS_DIR:-/opt/site-agent/.secrets}:/secrets:ro
    command:
      - sh
      - -c
      - |
          export INFLUX_TOKEN="$(cat /secrets/influx.telegraf.token)"
          exec telegraf --config /etc/telegraf/telegraf.conf

volumes:
  influx-data:
  influx-config:

secrets:
  influx_admin_user:
    file: ${IPC_SECRETS_DIR:-./.secrets}/influx.admin.user
  influx_admin_pass:
    file: ${IPC_SECRETS_DIR:-./.secrets}/influx.admin.pass
  influx_admin_token:
    file: ${IPC_SECRETS_DIR:-./.secrets}/influx.admin.token
